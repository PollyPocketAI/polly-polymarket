<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸ¦‰ Polly â€” Polymarket Research</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0d0f14;
      --card: #151820;
      --border: #242836;
      --accent: #4f8ef7;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #f59e0b;
      --text: #e2e8f0;
      --muted: #64748b;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
    }

    header {
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--card);
    }

    header h1 { font-size: 1.25rem; font-weight: 700; }
    header .tagline { color: var(--muted); font-size: 0.85rem; margin-left: auto; }

    .status-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 6px var(--green);
    }

    main { padding: 24px; max-width: 1400px; margin: 0 auto; }

    .tabs {
      display: flex; gap: 4px; margin-bottom: 24px;
      border-bottom: 1px solid var(--border); padding-bottom: 0;
    }

    .tab {
      padding: 10px 20px; cursor: pointer; font-size: 0.9rem;
      border-bottom: 2px solid transparent; color: var(--muted);
      transition: all 0.15s;
    }

    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .panel { display: none; }
    .panel.active { display: block; }

    /* â”€â”€ Markets Table â”€â”€ */
    .controls {
      display: flex; gap: 12px; margin-bottom: 16px; align-items: center;
    }

    .search-input {
      flex: 1; padding: 8px 12px; background: var(--card);
      border: 1px solid var(--border); border-radius: 8px;
      color: var(--text); font-size: 0.9rem; outline: none;
    }

    .search-input:focus { border-color: var(--accent); }

    .btn {
      padding: 8px 16px; border-radius: 8px; border: none;
      background: var(--accent); color: white; cursor: pointer;
      font-size: 0.85rem; font-weight: 600;
    }

    .btn:hover { opacity: 0.85; }
    .btn.secondary { background: var(--border); color: var(--text); }

    table { width: 100%; border-collapse: collapse; }

    th {
      text-align: left; padding: 10px 12px;
      font-size: 0.75rem; text-transform: uppercase;
      letter-spacing: 0.05em; color: var(--muted);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--bg); z-index: 10;
      cursor: pointer; user-select: none;
    }

    th:hover { color: var(--text); }

    td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 0.87rem; }

    tr:hover td { background: rgba(79, 142, 247, 0.04); }

    .price-bar {
      display: flex; align-items: center; gap: 8px;
    }

    .price-pill {
      padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;
    }

    .price-high { background: rgba(34, 197, 94, 0.15); color: var(--green); }
    .price-low  { background: rgba(239, 68, 68, 0.15); color: var(--red); }
    .price-mid  { background: rgba(245, 158, 11, 0.15); color: var(--yellow); }

    .mini-bar {
      height: 4px; border-radius: 2px; background: var(--border);
      width: 80px; overflow: hidden; flex-shrink: 0;
    }

    .mini-bar-fill {
      height: 100%; border-radius: 2px;
      background: linear-gradient(to right, var(--red), var(--yellow), var(--green));
    }

    .vol-chip { color: var(--muted); font-size: 0.82rem; }
    .tag-chip {
      display: inline-block; padding: 1px 6px; border-radius: 4px;
      background: var(--border); font-size: 0.72rem; color: var(--muted);
      margin-right: 4px;
    }

    .question-cell { max-width: 420px; }
    .question-text { line-height: 1.4; }

    .loading {
      text-align: center; padding: 60px; color: var(--muted); font-size: 0.9rem;
    }

    .spinner {
      display: inline-block; width: 20px; height: 20px;
      border: 2px solid var(--border); border-top-color: var(--accent);
      border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .refresh-info { font-size: 0.78rem; color: var(--muted); margin-left: auto; }

    /* â”€â”€ Decisions â”€â”€ */
    .decisions-grid { display: grid; gap: 12px; }

    .decision-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 10px; padding: 16px; cursor: pointer;
      transition: border-color 0.15s;
    }

    .decision-card:hover { border-color: var(--accent); }

    .decision-header { display: flex; gap: 12px; align-items: flex-start; }

    .verdict-badge {
      padding: 2px 10px; border-radius: 5px; font-size: 0.78rem;
      font-weight: 700; white-space: nowrap; flex-shrink: 0;
    }

    .verdict-BET_YES { background: rgba(34, 197, 94, 0.15); color: var(--green); }
    .verdict-BET_NO  { background: rgba(239, 68, 68, 0.15); color: var(--red); }
    .verdict-PASS    { background: rgba(100, 116, 139, 0.15); color: var(--muted); }
    .verdict-UNKNOWN { background: var(--border); color: var(--muted); }

    .empty-state {
      text-align: center; padding: 80px 40px; color: var(--muted);
    }

    .empty-state h2 { font-size: 1.1rem; margin-bottom: 8px; }
    .empty-state p { font-size: 0.85rem; }

    /* â”€â”€ Modal â”€â”€ */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.7); z-index: 100;
      align-items: center; justify-content: center; padding: 24px;
    }

    .modal-overlay.open { display: flex; }

    .modal {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; max-width: 700px; width: 100%;
      max-height: 80vh; overflow-y: auto; padding: 24px;
    }

    .modal-close {
      float: right; cursor: pointer; color: var(--muted); font-size: 1.2rem;
    }

    .modal pre {
      white-space: pre-wrap; font-family: inherit; font-size: 0.85rem;
      line-height: 1.6; color: var(--text);
    }

    /* â”€â”€ Stats bar â”€â”€ */
    .stats-bar {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 12px; margin-bottom: 24px;
    }

    .stat-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 10px; padding: 16px;
    }

    .stat-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .stat-value { font-size: 1.4rem; font-weight: 700; margin-top: 4px; }
    .stat-sub { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }
  </style>
</head>
<body>
  <header>
    <span style="font-size:1.5rem">ðŸ¦‰</span>
    <h1>Polly</h1>
    <div class="status-dot" id="statusDot"></div>
    <span class="tagline">Polymarket Research Agent</span>
  </header>

  <main>
    <div class="stats-bar" id="statsBar">
      <div class="stat-card">
        <div class="stat-label">Active Markets</div>
        <div class="stat-value" id="statMarkets">â€”</div>
        <div class="stat-sub">with order book</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Top 24h Volume</div>
        <div class="stat-value" id="statTopVol">â€”</div>
        <div class="stat-sub" id="statTopName">â€”</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Decisions Logged</div>
        <div class="stat-value" id="statDecisions">â€”</div>
        <div class="stat-sub">in decisions/</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Last Updated</div>
        <div class="stat-value" id="statUpdated" style="font-size:0.9rem;margin-top:8px">â€”</div>
        <div class="stat-sub">auto-refresh 60s</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="markets">Markets</div>
      <div class="tab" data-tab="decisions">Decisions</div>
    </div>

    <!-- Markets Panel -->
    <div class="panel active" id="tab-markets">
      <div class="controls">
        <input type="text" class="search-input" id="searchInput" placeholder="Filter markets..." />
        <button class="btn secondary" onclick="loadMarkets()">â†» Refresh</button>
        <span class="refresh-info" id="refreshInfo"></span>
      </div>
      <div id="marketsContainer">
        <div class="loading"><span class="spinner"></span>Loading markets...</div>
      </div>
    </div>

    <!-- Decisions Panel -->
    <div class="panel" id="tab-decisions">
      <div id="decisionsContainer">
        <div class="loading"><span class="spinner"></span>Loading decisions...</div>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal">
      <span class="modal-close" onclick="closeModal()">âœ•</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    let allMarkets = [];
    let sortKey = "volume24h";
    let sortDir = -1;

    // â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add("active");
        if (tab.dataset.tab === "decisions") loadDecisions();
      });
    });

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function fmt(n) {
      if (n >= 1e6) return `$${(n/1e6).toFixed(1)}M`;
      if (n >= 1e3) return `$${(n/1e3).toFixed(0)}K`;
      return `$${n.toFixed(0)}`;
    }

    function priceClass(p) {
      if (p >= 0.7) return "price-high";
      if (p <= 0.3) return "price-low";
      return "price-mid";
    }

    // â”€â”€ Markets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadMarkets() {
      try {
        const r = await fetch("/api/markets?limit=50");
        const data = await r.json();
        if (!data.ok) throw new Error(data.error);
        allMarkets = data.markets;
        document.getElementById("statMarkets").textContent = allMarkets.length;
        const top = allMarkets[0];
        if (top) {
          document.getElementById("statTopVol").textContent = fmt(top.volume24h);
          document.getElementById("statTopName").textContent = top.question.slice(0, 30) + "â€¦";
        }
        document.getElementById("statUpdated").textContent =
          new Date().toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" });
        document.getElementById("refreshInfo").textContent =
          `Fetched ${allMarkets.length} markets Â· ${new Date(data.fetchedAt).toLocaleTimeString()}`;
        renderMarkets();
      } catch (err) {
        document.getElementById("marketsContainer").innerHTML =
          `<div class="loading" style="color:var(--red)">Error: ${err.message}</div>`;
      }
    }

    function renderMarkets() {
      const q = document.getElementById("searchInput").value.toLowerCase();
      let markets = allMarkets.filter(m =>
        !q || m.question.toLowerCase().includes(q)
      );

      markets = [...markets].sort((a, b) =>
        sortDir * (a[sortKey] > b[sortKey] ? 1 : -1)
      );

      const html = `
        <table>
          <thead>
            <tr>
              <th onclick="sortBy('question')">Market</th>
              <th onclick="sortBy('yesPrice')">YES%</th>
              <th onclick="sortBy('volume24h')">24h Vol â–¾</th>
              <th onclick="sortBy('volume')">Total Vol</th>
              <th onclick="sortBy('liquidity')">Liquidity</th>
              <th onclick="sortBy('endDate')">Ends</th>
            </tr>
          </thead>
          <tbody>
            ${markets.map(m => `
              <tr>
                <td class="question-cell">
                  <div class="question-text">${m.question}</div>
                  ${m.tags.slice(0,2).map(t => `<span class="tag-chip">${t}</span>`).join("")}
                </td>
                <td>
                  <div class="price-bar">
                    <span class="price-pill ${priceClass(m.yesPrice)}">${(m.yesPrice*100).toFixed(0)}%</span>
                    <div class="mini-bar">
                      <div class="mini-bar-fill" style="width:${m.yesPrice*100}%"></div>
                    </div>
                  </div>
                </td>
                <td><span class="vol-chip">${fmt(m.volume24h)}</span></td>
                <td><span class="vol-chip">${fmt(m.volume)}</span></td>
                <td><span class="vol-chip">${fmt(m.liquidity)}</span></td>
                <td style="color:var(--muted);font-size:0.82rem">${m.endDate || "â€”"}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>`;
      document.getElementById("marketsContainer").innerHTML = html;
    }

    function sortBy(key) {
      if (sortKey === key) sortDir *= -1;
      else { sortKey = key; sortDir = -1; }
      renderMarkets();
    }

    document.getElementById("searchInput").addEventListener("input", renderMarkets);

    // â”€â”€ Decisions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadDecisions() {
      try {
        const r = await fetch("/api/decisions");
        const data = await r.json();
        document.getElementById("statDecisions").textContent = data.decisions.length;

        if (!data.decisions.length) {
          document.getElementById("decisionsContainer").innerHTML = `
            <div class="empty-state">
              <h2>No decisions logged yet</h2>
              <p>Polly will log every research decision here as she works.</p>
            </div>`;
          return;
        }

        const html = `<div class="decisions-grid">` +
          data.decisions.map(d => `
            <div class="decision-card" onclick="openDecision('${d.file}')">
              <div class="decision-header">
                <span class="verdict-badge verdict-${d.verdict.replace(/\s/g,'_')}">${d.verdict}</span>
                <span style="font-size:0.87rem">${d.question}</span>
              </div>
              <div style="margin-top:8px;font-size:0.78rem;color:var(--muted)">${d.date}</div>
            </div>
          `).join("") + `</div>`;
        document.getElementById("decisionsContainer").innerHTML = html;
      } catch (err) {
        document.getElementById("decisionsContainer").innerHTML =
          `<div class="loading" style="color:var(--red)">Error: ${err.message}</div>`;
      }
    }

    async function openDecision(file) {
      const r = await fetch(`/api/decisions/${file}`);
      const data = await r.json();
      document.getElementById("modalContent").innerHTML =
        `<pre>${data.content}</pre>`;
      document.getElementById("modalOverlay").classList.add("open");
    }

    function closeModal(e) {
      if (!e || e.target === document.getElementById("modalOverlay")) {
        document.getElementById("modalOverlay").classList.remove("open");
      }
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loadMarkets();
    setInterval(loadMarkets, 60000);
  </script>
</body>
</html>
